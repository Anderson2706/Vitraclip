<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vitraclip | Vision Neural</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        :root { 
            --primary: #255fff; 
            --bg-dark: #05070a; 
            --card-dark: #0c0e14; 
            --border: #1a1d23;
        }
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: var(--bg-dark); font-family: 'Plus Jakarta Sans', sans-serif; 
            overflow: hidden; color: white; 
        }
        /* Câmera em Full Screen Total */
        #video-container {
            position: fixed; inset: 0; z-index: 1;
            background: #000;
        }
        #video { width: 100%; height: 100%; object-fit: cover; }
        /* Interface de Sobreposição */
        .ui-overlay {
            position: absolute; inset: 0; z-index: 10;
            display: flex; flex-direction: column;
            justify-content: space-between;
            background: radial-gradient(circle, transparent 20%, rgba(5, 7, 10, 0.7) 100%);
        }
        /* Header Estilo Dashboard */
        .header {
            background: rgba(12, 14, 20, 0.9);
            border-bottom: 1px solid var(--border);
            padding: 20px; display: flex; justify-content: space-between; align-items: center;
            backdrop-filter: blur(10px);
        }
        /* Área de Foco */
        .viewport {
            flex: 1; display: flex; align-items: center; justify-content: center;
        }
        .scanner-window {
            width: 85%; height: 260px;
            border: 2px solid var(--primary);
            border-radius: 24px; position: relative;
            box-shadow: 0 0 0 9999px rgba(5, 7, 10, 0.4); 
        }
        .laser-line {
            position: absolute; width: 100%; height: 2px;
            background: var(--primary); box-shadow: 0 0 15px var(--primary);
            top: 0; animation: scanMove 2.5s infinite ease-in-out;
        }
        /* Footer com os botões */
        .footer {
            background: rgba(12, 14, 20, 0.95);
            border-top: 1px solid var(--border);
            padding: 35px 20px;
            display: flex; justify-content: space-around; align-items: center;
            backdrop-filter: blur(10px);
        }
        .btn-action {
            width: 60px; height: 60px; border-radius: 16px;
            background: var(--bg-dark); border: 1px solid var(--border);
            color: white; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: 0.3s;
        }
        .btn-action:hover { border-color: var(--primary); color: var(--primary); }
        .btn-main-capture {
            width: 85px; height: 85px; border-radius: 50%;
            background: var(--primary); border: 6px solid #0c0e14;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 20px rgba(37, 95, 255, 0.4);
            transition: 0.2s;
        }
        .btn-main-capture:active { transform: scale(0.9); }
        /* Loader IA */
        #ia-processing {
            display: none; position: fixed; inset: 0; z-index: 100;
            background: var(--bg-dark); flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner {
            width: 50px; height: 50px; border: 4px solid var(--border);
            border-top-color: var(--primary); border-radius: 50%;
            animation: spin 1s infinite linear;
        }
        @keyframes scanMove { 0%, 100% { top: 0%; } 50% { top: 100%; } }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="ia-processing">
        <div class="spinner"></div>
        <h3 style="margin-top: 20px; letter-spacing: 2px;">PROCESSANDO IA</h3>
        <p style="color: #555; font-size: 0.8rem;">IDENTIFICANDO VALORES E PADRÕES</p>
    </div>
    <div id="video-container">
        <video id="video" autoplay playsinline></video>
    </div>
    <div class="ui-overlay">
        <div class="header">
            <button onclick="location.href='dashboard.html'" class="btn-action" style="width: 45px; height: 45px;">
                <i data-lucide="arrow-left"></i>
            </button>
            <div style="text-align: center;">
                <span style="font-weight: 800; font-size: 0.7rem; color: var(--primary); letter-spacing: 1px;">VITRACLIP VISION</span>
            </div>
            <div style="width: 45px;"></div>
        </div>
        <div class="viewport">
            <div class="scanner-window">
                <div class="laser-line"></div>
            </div>
        </div>
        <div class="footer">
            <label class="btn-action">
                <i data-lucide="image"></i>
                <input type="file" id="upload-input" accept="image/*" style="display:none">
            </label>
            <button class="btn-main-capture" id="capture-btn">
                <i data-lucide="scan" color="white" size="32"></i>
            </button>
            <button class="btn-action" id="btn-flash">
                <i data-lucide="zap"></i>
            </button>
        </div>
    </div>
    <canvas id="output-canvas" style="display:none;"></canvas>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<script>
    lucide.createIcons();

    const video = document.getElementById('video');
    const canvas = document.getElementById('output-canvas');
    const processing = document.getElementById('ia-processing');
    let worker = null;

    // Configuração do Worker do PDF.js
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    async function loadIA() {
        worker = await Tesseract.createWorker('por');
        // Parâmetros focados em documentos comerciais
        await worker.setParameters({
            tessedit_char_whitelist: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz/.,-:$ ',
            tessedit_pageseg_mode: '1', // Tenta achar blocos de texto automaticamente
        });
    }

    loadIA();

    // Iniciar Câmera
    navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: 'environment', width: { ideal: 1920 } } 
    }).then(stream => video.srcObject = stream);

    // Evento de Captura pela Câmera
    document.getElementById('capture-btn').onclick = () => runAI(video);

    // Configuração do Upload (Imagens e PDF)
    const uploadInput = document.getElementById('upload-input');
    uploadInput.setAttribute('accept', 'image/*,.pdf');

    uploadInput.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        if (file.type === "application/pdf") { 
            processPDF(file); 
        } else {
            const reader = new FileReader();
            reader.onload = (ev) => {
                const img = new Image();
                img.onload = () => runAI(img);
                img.src = ev.target.result;
            };
            reader.readAsDataURL(file);
        }
    };

    // Filtro de Nitidez para fotos da câmera
    function refineImage(ctx, width, height) {
        ctx.globalCompositeOperation = 'contrast';
        ctx.filter = 'contrast(1.4) brightness(1.1) saturate(0)'; 
        ctx.drawImage(canvas, 0, 0);
        ctx.globalCompositeOperation = 'source-over';
    }

    // Processamento de PDF: Converte a primeira página em imagem para o OCR
    async function processPDF(file) {
        processing.style.display = 'flex';
        const reader = new FileReader();
        reader.onload = async function() {
            try {
                const typedarray = new Uint8Array(this.result);
                const pdf = await pdfjsLib.getDocument(typedarray).promise;
                const page = await pdf.getPage(1);

                // Escala de 2.5 para garantir que letras pequenas do boleto fiquem nítidas
                const viewport = page.getViewport({ scale: 2.5 }); 
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                const ctx = canvas.getContext('2d');

                await page.render({ canvasContext: ctx, viewport: viewport }).promise;

                // Envia o canvas renderizado para a IA
                runAI(canvas, true);
            } catch (err) {
                console.error("Erro ao processar PDF:", err);
                processing.style.display = 'none';
                alert("Erro ao ler o arquivo PDF.");
            }
        };
        reader.readAsArrayBuffer(file);
    }

    // Motor de Execução da IA (OCR)
    async function runAI(source, isPDF = false) {
        processing.style.display = 'flex';
        const ctx = canvas.getContext('2d');
        
        // Ajusta dimensões do canvas baseada na origem
        canvas.width = source.videoWidth || source.width;
        canvas.height = source.videoHeight || source.height;

        if (!isPDF) {
            ctx.drawImage(source, 0, 0);
            refineImage(ctx, canvas.width, canvas.height);
        } else {
            // Se for PDF, o canvas já está pronto e desenhado
            ctx.drawImage(source, 0, 0);
        }

        try {
            const { data: { text } } = await worker.recognize(canvas);
            if (!text || text.trim().length < 5) throw new Error("Leitura fraca");
            extractData(text);
        } catch (err) {
            console.error("Erro OCR:", err);
            // Fallback: Tenta ler sem filtro caso a imagem esteja muito escura/clara
            ctx.filter = 'none';
            ctx.drawImage(source, 0, 0);
            const { data: { text } } = await worker.recognize(canvas);
            extractData(text);
        }
    }

    // Lógica de Extração de Dados (Sua lógica original)
    function extractData(raw) {
        const text = raw.toUpperCase();
        
        // Extração de Valor
        const valorRegex = /\d{1,3}(?:\.\d{3})*,\d{2}/g;
        const matches = text.match(valorRegex) || [];
        const numVals = matches.map(v => parseFloat(v.replace(/\./g, '').replace(',', '.'))).filter(n => n > 2.0);
        
        const valorFinal = numVals.length > 0 ? Math.max(...numVals) : 0;
        const valorOriginalStr = matches[numVals.indexOf(valorFinal)] || "0,00";

        // Extração de Data
        const dataRegex = /\d{2}\/\d{2}\/\d{4}/g;
        const dates = text.match(dataRegex) || [];
        const vencimento = dates.length > 0 ? dates[dates.length - 1] : new Date().toLocaleDateString();

        // Identificação de Empresa/Fluxo
        const userData = JSON.parse(localStorage.getItem('vitraclip_user_data')) || {};
        const minhaEmpresa = (userData.empresa || "").toUpperCase();
        
        let fluxo = "Despesa";
        let categoria = "Geral";
        let docType = "Boleto Comercial";

        if (minhaEmpresa && text.includes(minhaEmpresa)) {
            fluxo = "Receita";
            categoria = "Faturamento";
        }

        // Categorização por Palavras-Chave
        const setores = [
            { n: "Energia", k: ["KWH", "LUZ", "ENEL", "CPFL", "LIGHT", "COPEL", "EQUATORIAL"] },
            { n: "Água", k: ["M3", "AGUA", "SABESP", "COPASA", "SANEPAR", "CEDAE"] },
            { n: "Internet", k: ["VIVO", "CLARO", "TIM", "OI FIBRA", "TELECOM", "NET S.A"] },
            { n: "Impostos", k: ["DARF", "DAS ", "FGTS", "SIMPLES", "PREFEITURA"] }
        ];

        for (let s of setores) {
            if (s.k.some(key => text.includes(key))) {
                categoria = s.n;
                docType = `Fatura ${s.n}`;
                break;
            }
        }

        const linhas = raw.split('\n').filter(l => l.trim().length > 3);
        const emissor = fluxo === "Receita" ? "Venda Cliente" : (linhas[0] || "Desconhecido");

        // Objeto de Resultado
        const novoScan = {
            id: Date.now(),
            empresa: emissor.substring(0, 30),
            tipo: docType,
            categoria: categoria,
            valor: valorFinal,
            valorFormatado: "R$ " + valorOriginalStr,
            fluxo: fluxo,
            data: vencimento,
            dataScan: new Date().toLocaleDateString(),
            status: 'pendente' // Adicionado para manter sincronia com suas novas telas
        };

        // Salvar e Redirecionar
        const db = JSON.parse(localStorage.getItem('vitraclip_scans')) || [];
        db.unshift(novoScan);
        localStorage.setItem('vitraclip_scans', JSON.stringify(db));

        window.location.href = 'dashboard.html';
    }
</script>
</body>
</html>
