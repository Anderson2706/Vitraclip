<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vitraclip | Vision Neural</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { 
            --primary: #255fff; 
            --bg-dark: #05070a; 
            --card-dark: #0c0e14; 
            --border: #1a1d23;
        }
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: var(--bg-dark); font-family: 'Plus Jakarta Sans', sans-serif; 
            overflow: hidden; color: white; 
        }
        /* Câmera em Full Screen Total */
        #video-container {
            position: fixed; inset: 0; z-index: 1;
            background: #000;
        }
        #video { width: 100%; height: 100%; object-fit: cover; }
        /* Interface de Sobreposição */
        .ui-overlay {
            position: absolute; inset: 0; z-index: 10;
            display: flex; flex-direction: column;
            justify-content: space-between;
            background: radial-gradient(circle, transparent 20%, rgba(5, 7, 10, 0.7) 100%);
        }
        /* Header Estilo Dashboard */
        .header {
            background: rgba(12, 14, 20, 0.9);
            border-bottom: 1px solid var(--border);
            padding: 20px; display: flex; justify-content: space-between; align-items: center;
            backdrop-filter: blur(10px);
        }
        /* Área de Foco */
        .viewport {
            flex: 1; display: flex; align-items: center; justify-content: center;
        }
        .scanner-window {
            width: 85%; height: 260px;
            border: 2px solid var(--primary);
            border-radius: 24px; position: relative;
            box-shadow: 0 0 0 9999px rgba(5, 7, 10, 0.4); 
        }
        .laser-line {
            position: absolute; width: 100%; height: 2px;
            background: var(--primary); box-shadow: 0 0 15px var(--primary);
            top: 0; animation: scanMove 2.5s infinite ease-in-out;
        }
        /* Footer com os botões */
        .footer {
            background: rgba(12, 14, 20, 0.95);
            border-top: 1px solid var(--border);
            padding: 35px 20px;
            display: flex; justify-content: space-around; align-items: center;
            backdrop-filter: blur(10px);
        }
        .btn-action {
            width: 60px; height: 60px; border-radius: 16px;
            background: var(--bg-dark); border: 1px solid var(--border);
            color: white; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: 0.3s;
        }
        .btn-action:hover { border-color: var(--primary); color: var(--primary); }
        .btn-main-capture {
            width: 85px; height: 85px; border-radius: 50%;
            background: var(--primary); border: 6px solid #0c0e14;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 20px rgba(37, 95, 255, 0.4);
            transition: 0.2s;
        }
        .btn-main-capture:active { transform: scale(0.9); }
        /* Loader IA */
        #ia-processing {
            display: none; position: fixed; inset: 0; z-index: 100;
            background: var(--bg-dark); flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner {
            width: 50px; height: 50px; border: 4px solid var(--border);
            border-top-color: var(--primary); border-radius: 50%;
            animation: spin 1s infinite linear;
        }
        @keyframes scanMove { 0%, 100% { top: 0%; } 50% { top: 100%; } }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="ia-processing">
        <div class="spinner"></div>
        <h3 style="margin-top: 20px; letter-spacing: 2px;">PROCESSANDO IA</h3>
        <p style="color: #555; font-size: 0.8rem;">IDENTIFICANDO VALORES E PADRÕES</p>
    </div>
    <div id="video-container">
        <video id="video" autoplay playsinline></video>
    </div>
    <div class="ui-overlay">
        <div class="header">
            <button onclick="location.href='dashboard.html'" class="btn-action" style="width: 45px; height: 45px;">
                <i data-lucide="arrow-left"></i>
            </button>
            <div style="text-align: center;">
                <span style="font-weight: 800; font-size: 0.7rem; color: var(--primary); letter-spacing: 1px;">VITRACLIP VISION</span>
            </div>
            <div style="width: 45px;"></div>
        </div>
        <div class="viewport">
            <div class="scanner-window">
                <div class="laser-line"></div>
            </div>
        </div>
        <div class="footer">
            <label class="btn-action">
                <i data-lucide="image"></i>
                <input type="file" id="upload-input" accept="image/*" style="display:none">
            </label>
            <button class="btn-main-capture" id="capture-btn">
                <i data-lucide="scan" color="white" size="32"></i>
            </button>
            <button class="btn-action" id="btn-flash">
                <i data-lucide="zap"></i>
            </button>
        </div>
    </div>
    <canvas id="output-canvas" style="display:none;"></canvas>
    <script>
        lucide.createIcons();
        const video = document.getElementById('video');
        const canvas = document.getElementById('output-canvas');
        const processing = document.getElementById('ia-processing');
        let worker = null;

        async function loadIA() {
            worker = await Tesseract.createWorker('por');
        }
        loadIA();

        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: { ideal: 1920 } } })
            .then(stream => video.srcObject = stream);

        document.getElementById('capture-btn').onclick = () => runAI(video);

        document.getElementById('upload-input').onchange = (e) => {
            const reader = new FileReader();
            reader.onload = (ev) => {
                const img = new Image();
                img.onload = () => runAI(img);
                img.src = ev.target.result;
            };
            reader.readAsDataURL(e.target.files[0]);
        };

        async function runAI(source) {
            processing.style.display = 'flex';
            const ctx = canvas.getContext('2d');
            canvas.width = source.videoWidth || source.width;
            canvas.height = source.videoHeight || source.height;
            ctx.filter = 'contrast(2.5) grayscale(1) brightness(1.0)';
            ctx.drawImage(source, 0, 0);
            try {
                const { data: { text } } = await worker.recognize(canvas.toDataURL('image/jpeg'));
                extractData(text);
            } catch (err) {
                alert("Erro ao processar.");
                processing.style.display = 'none';
            }
        }

        function extractData(raw) {
            const text = raw.toUpperCase();
            let brain = JSON.parse(localStorage.getItem('vitraclip_brain')) || {};
            
            const valorRegex = /\d{1,3}(?:\.\d{3})*,\d{2}/g;
            const dataRegex = /\d{2}\/\d{2}\/\d{4}/g;
            
            const vals = text.match(valorRegex) || [];
            const dates = text.match(dataRegex) || [];

            let docType = "Boleto Geral";
            if (text.includes("ENEL")) docType = "Conta Enel";
            if (text.includes("CAIXA")) docType = "Boleto Caixa";
            if (text.includes("BRADESCO")) docType = "Boleto Bradesco";

            // CORREÇÃO DOS VALORES BUGADOS: 
            // Pega a string "1.250,00", remove ponto e troca vírgula por ponto para virar número real
            const valorRaw = vals.length > 0 ? vals[vals.length - 1] : "0,00";
            const valorNumerico = parseFloat(valorRaw.replace(/\./g, '').replace(',', '.'));

            const novoScan = {
                id: Date.now(),
                empresa: docType,
                tipo: docType, // Adicionado para compatibilidade com a tabela do dash
                valor: valorNumerico, // SALVA COMO NÚMERO PARA NÃO BUGAR O DASHBOARD
                valorFormatado: "R$ " + valorRaw, // Para uso visual se necessário
                data: dates.length > 0 ? dates[0] : new Date().toLocaleDateString(),
                dataScan: new Date().toLocaleDateString()
            };

            const db = JSON.parse(localStorage.getItem('vitraclip_scans')) || [];
            db.unshift(novoScan);
            localStorage.setItem('vitraclip_scans', JSON.stringify(db));

            window.location.href = 'dashboard.html';
        }
    </script>
</body>
</html>